/**
 * # Firestore Security Rules for Career Compass AI
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model for all personal data, ensuring that users can only access and modify their own information. All application-level data (like quiz questions and career stream information) is treated as public but is made read-only for clients to protect its integrity. The default security posture is to deny all access unless explicitly granted.
 *
 * ## Data Structure
 * The data is organized hierarchically to simplify security. All private user data, including quiz answers, career recommendations, and simulation feedback, is stored in subcollections under the `/users/{userId}` path. This structure allows for simple, performant, and secure path-based authorization. Publicly accessible, shared data resides in top-level collections like `/questions`, `/careerStreams`, and `/roadmapMilestones`.
 *
 * ## Key Security Decisions
 * - **Strict Ownership**: All user-generated content is locked down to the user who created it.
 * - **No User Listing**: To protect user privacy, it is not possible to list all documents in the `/users` collection.
 * - **Read-Only Public Data**: Core application data is readable by any authenticated user but cannot be modified by clients. This prevents vandalism and ensures data consistency. Content must be managed via the Firebase Console or a trusted backend server using the Admin SDK.
 * - **Path-Based Authorization**: Rules leverage the `{userId}` wildcard in the document path to grant access, which is highly performant as it avoids extra database reads (`get()` calls).
 *
 * ## Denormalization and Integrity
 * To ensure relational integrity and enable efficient rules, documents created within a user's private space (e.g., a quiz answer) must contain a `userId` field that matches the `userId` in the document path. These relational fields are enforced as immutable after creation to prevent documents from being "moved" between users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * A robust check for update/delete operations, ensuring the user is the
     * owner AND the document already exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * For user documents, validates that the internal `id` field matches the
     * document's path ID during creation.
     */
    function hasValidUserDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * For user documents, ensures the internal `id` field is immutable on update.
     */
    function isUserDataImmutableOnUpdate() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * For user subcollections, validates that the internal `userId` field
     * matches the owner's path ID during creation.
     */
    function hasValidSubcollectionDataOnCreate(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * For user subcollections, ensures the internal `userId` field is immutable on update.
     */
    function isSubcollectionDataImmutableOnUpdate() {
      return request.resource.data.userId == resource.data.id;
    }


    // ----------------------------------------------------------------------
    // User Data Collections
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document.
     * @deny (list) Another user trying to list all user profiles.
     * @principle A user can create their own profile, but cannot view or edit others' profiles. User enumeration is forbidden.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && isUserDataImmutableOnUpdate();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Controls access to a user's quiz answers.
       * @path /users/{userId}/quizAnswers/{quizAnswerId}
       * @allow (create, list) An authenticated user creating or listing their own quiz answers.
       * @deny (get) Another user trying to read a specific quiz answer.
       * @principle Restricts access to a user's own data tree using path-based ownership.
       */
      match /quizAnswers/{quizAnswerId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidSubcollectionDataOnCreate(userId);
        allow update: if isExistingOwner(userId) && isSubcollectionDataImmutableOnUpdate();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Controls access to a user's career recommendations.
       * @path /users/{userId}/careerRecommendations/{careerRecommendationId}
       * @allow (create, list) An authenticated user creating or listing their own recommendations.
       * @deny (get) Another user trying to read a specific recommendation.
       * @principle Restricts access to a user's own data tree using path-based ownership.
       */
      match /careerRecommendations/{careerRecommendationId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidSubcollectionDataOnCreate(userId);
        allow update: if isExistingOwner(userId) && isSubcollectionDataImmutableOnUpdate();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Controls access to a user's simulation feedback.
       * @path /users/{userId}/simulationFeedback/{simulationFeedbackId}
       * @allow (create, list) An authenticated user creating or listing their own feedback.
       * @deny (get) Another user trying to read a specific feedback document.
       * @principle Restricts access to a user's own data tree using path-based ownership.
       */
      match /simulationFeedback/{simulationFeedbackId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidSubcollectionDataOnCreate(userId);
        allow update: if isExistingOwner(userId) && isSubcollectionDataImmutableOnUpdate();
        allow delete: if isExistingOwner(userId);
      }
    }


    // ----------------------------------------------------------------------
    // Public Read-Only Collections
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to quiz questions. Publicly readable, not client-writable.
     * @path /questions/{questionId}
     * @allow (get, list) Any authenticated user reading the quiz questions.
     * @deny (create, update, delete) Any user trying to modify the questions.
     * @principle Protects the integrity of core application data by making it read-only for clients.
     */
    match /questions/{questionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to career stream information. Publicly readable, not client-writable.
     * @path /careerStreams/{careerStreamId}
     * @allow (get, list) Any authenticated user reading career stream data.
     * @deny (create, update, delete) Any user trying to modify career streams.
     * @principle Protects the integrity of core application data by making it read-only for clients.
     */
    match /careerStreams/{careerStreamId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to roadmap milestones. Publicly readable, not client-writable.
     * @path /roadmapMilestones/{roadmapMilestoneId}
     * @allow (get, list) Any authenticated user reading roadmap milestone data.
     * @deny (create, update, delete) Any user trying to modify milestones.
     * @principle Protects the integrity of core application data by making it read-only for clients.
     */
    match /roadmapMilestones/{roadmapMilestoneId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}